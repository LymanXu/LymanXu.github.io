<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>部署Neutron LBaas操作命令记录</title>
</head>
<body>
<h2 style="margin-left:21.0pt;text-indent:-21.0pt;">
    <strong>一．&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        基本配置参数</strong>
</h2>
<p class="MsoListParagraph" style="margin-left:21.0pt;text-indent:-21.0pt;">
    <span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:-18.0pt;">
    1. 虚拟机配置<span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    网络：<span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;">
    <span></span><span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;">
    <span></span><span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;">
    <span></span><span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;">
    <span></span><span>&nbsp;</span>
</p>
<p class="MsoNormal">
    <span>&nbsp;&nbsp; </span>系统：<span></span>
</p>
<p class="MsoNormal">
    <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>内存<span>&nbsp;4g(4096),</span>显存<span>16M</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:-18.0pt;">
    <strong>2. local.conf文件配置</strong><span></span>
</p>
<p class="MsoNormal" align="left">
    [[local|localrc]]<br />
    HOST_IP=192.168.56.202<br />
    SERVICE_HOST=192.168.56.202<br />
    MYSQL_HOST=192.168.56.202<br />
    RABBIT_HOST=192.168.56.202<br />
    GLANCE_HOST=192.168.56.202<br />
    ADMIN_PASSWORD=password<br />
    DATABASE_PASSWORD=password<br />
    RABBIT_PASSWORD=password<br />
    SERVICE_PASSWORD=password<br />
    <br />
    LOGFILE=/opt/stack/logs/stack.sh.log<br />
    VERBOSE=True<br />
    LOG_COLOR=True<br />
    SCREEN_LOGDIR=/opt/stack/logs<br />
    <br />
    #&nbsp;Use&nbsp;Neutron&nbsp;instead&nbsp;of&nbsp;nova-network<br />
    disable_service&nbsp;n-net<br />
    enable_service&nbsp;q-svc<br />
    enable_service&nbsp;q-dhcp<br />
    enable_service&nbsp;q-agt<br />
    enable_service&nbsp;q-l3<br />
    <br />
    enable_service&nbsp;c-api<br />
    enable_service&nbsp;c-vol<br />
    enable_service&nbsp;c-sch<br />
    <br />
    disable_service&nbsp;n-obj<br />
    disable_service&nbsp;c-bak<br />
    disable_service&nbsp;tempest<br />
    disable_service&nbsp;horizon<br />
    <br />
    ##&nbsp;Neutron&nbsp;options<br />
    Q_USE_SECGROUP=False<br />
    <br />
    NEUTRON_CREATE_INITIAL_NETWORKS=False<br />
    <br />
    <span># Open vSwitch provider networking configuration</span>
</p>
<p class="MsoNormal" align="left">
    <span>Q_USE_PROVIDERNET_FOR_PUBLIC=True</span>
</p>
<p class="MsoNormal" align="left">
    <span>OVS_PHYSICAL_BRIDGE=br-ex</span>
</p>
<p class="MsoNormal" align="left">
    <span>PUBLIC_BRIDGE=br-ex</span>
</p>
<p class="MsoNormal" align="left">
    <span>OVS_BRIDGE_MAPPINGS=extern:br-ex </span>
</p>
<p class="MsoNormal" align="left">
    <span>PUBLIC_INTERFACE=enp0s8</span>
</p>
<p class="MsoNormal" align="left">
    <span>Q_ML2_PLUGIN_VLAN_TYPE_OPTIONS=(network_vlan_ranges=bridge:2001:3000,extern:3001:4000)</span>
</p>
<p class="MsoNormal" align="left">
    <span>&nbsp;</span>
</p>
<p class="MsoNormal" align="left">
	<span>enable_plugin neutron-lbaas
https://github.com/openstack/neutron-lbaas.git</span>
</p>
<p class="MsoNormal" align="left">
    <span>enable_plugin octavia https://github.com/openstack/octavia.git</span>
</p>
<p class="MsoNormal" align="left">
    <span>ENABLED_SERVICES+=,q-lbaasv2</span>
</p>
<p class="MsoNormal" align="left">
    <span>ENABLED_SERVICES+=,octavia,o-cw,o-hk,o-hm,o-api</span>
</p>
<p class="MsoNormal">
    <span>&nbsp;</span>
</p>
<p class="MsoNormal" align="left">
    <b>注意点<span>:</span></b>
</p>
<p class="MsoNormal" align="left">
    <span>1. &nbsp;(</span>注意这里的<span>bridge-mapping</span>要和下面的<span>vlan</span>对应<span>)</span>
</p>
<p class="MsoNormal">
    <span>2. </span>在<span>=</span>后面千万不要有空格<span></span>
</p>
<p class="MsoListParagraph" style="text-indent:0cm;">
    二．<span> linux</span>命令所遇到的问题<span></span>
</p>
<p class="MsoListParagraph" style="text-indent:0cm;">
    <span>&nbsp;</span>&nbsp; 1. 文件拒绝访问，添加权限<span></span>
</p>
<p class="MsoNormal">
    <span>&nbsp;&nbsp;</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    <span>Permission denied.</span>
</p>
<p class="MsoListParagraph" style="margin-left:36.0pt;text-indent:-18.0pt;">
    Ø&nbsp; <span>ls –l /etc/sudoers </span>查看权限<span></span>
</p>
<p class="MsoListParagraph" style="margin-left:36.0pt;text-indent:0cm;">
    <span></span><span></span>
</p>
<p class="MsoListParagraph" style="margin-left:36.0pt;text-indent:0cm;">
    可以看到，<span>/etc/sudoers</span>为非目录，文件主有<span>r(</span>只读权限<span>)</span>，同组的用户有<span>r</span>权限，其他用户没有任何权限<span></span>
</p>
<p class="MsoListParagraph" style="margin-left:36.0pt;text-indent:-18.0pt;">
    Ø&nbsp; 添加权限，这里会遇到一个操作不被允许的问题<span></span>
</p>
<p class="MsoListParagraph" style="margin-left:36.0pt;text-indent:0cm;">
    <span></span><span></span>
</p>
<p class="MsoListParagraph" style="margin-left:36.0pt;text-indent:0cm;">
    通过<span>root</span>用户进行权限修改<span></span>
</p>
<p class="MsoListParagraph" style="margin-left:36.0pt;text-indent:0cm;">
    <span></span><span></span>
</p>
<p class="MsoNormal">
    <span>&nbsp;</span>
</p>
<p class="MsoNormal">
    为用户添加<span>sudo</span>权限（修改<span>sudoers</span>文件）<span></span>
</p>
<p class="MsoNormal">
    <span>http://www.cnblogs.com/youngerchina/p/5624473.html</span>
</p>
<p class="MsoNormal">
    <b>所遇问题：<span></span></b>
</p>
<p class="MsoNormal" style="text-indent:21.0pt;">
    在<span>sudoers</span>文件中 加入<span></span>
</p>
<p class="MsoNormal" style="text-indent:21.0pt;">
    <span>stack ALL=(ALL) ALL</span>
</p>
<p class="MsoNormal" style="text-indent:21.0pt;">
    切换到<span> stack</span>用户，新建文件夹失败，感觉权限修改没生效，其实是在上一个用户的目录下，导致非<span>root</span>用户没有权限。注意在<span>chmod 777 /etc/sudoers </span>，是所有用户对该文件都有权限，修改过后记得
    恢复<span>chmod 440 /etc/sudoers</span>，否则会出现无法使用<span>sudo</span>命令。<span></span>
</p>
<h1>
    三 搭建<span>devstack</span>细节<span></span>
</h1>
<p class="MsoNormal" style="text-indent:24.0pt;">
    <span>clone: </span>在<span>/opt/stack</span>目录下<span></span>
</p>
<p class="MsoNormal" style="text-indent:21.0pt;">
	<span>keystone&nbsp; nova&nbsp;
neutron&nbsp; cinder&nbsp; glance&nbsp; </span>
</p>
<h1>
    四<span>. </span>配置基础环境及<span>ssh</span>连接<span></span>
</h1>
<p class="MsoNormal" style="text-indent:21.0pt;">
    <span>1. Ubuntu</span>常用国内源地址<span></span>
</p>
<p class="MsoNormal" style="text-indent:21.0pt;">
    <span>&nbsp;<a href="http://wiki.ubuntu.com.cn/%E6%BA%90%E5%88%97%E8%A1%A8">http://wiki.ubuntu.com.cn/%E6%BA%90%E5%88%97%E8%A1%A8</a></span>
</p>
<p class="MsoNormal" style="text-indent:21.0pt;">
    <span>2. </span>安装<span>ssh</span>
</p>
<p class="MsoNormal" style="text-indent:21.0pt;">
    <span><a href="http://www.linuxidc.com/Linux/2016-12/137908.htm">http://www.linuxidc.com/Linux/2016-12/137908.htm</a></span>
</p>
<p class="MsoNormal" style="text-indent:21.0pt;">
    <span>&nbsp;</span>
</p>
<h1>
    五．创建网络并起虚拟机<span></span>
</h1>
<p class="MsoNormal">
    <span>2. </span>查看当前网络<span></span>
</p>
<p class="MsoNormal">
    <span>&nbsp; &nbsp;&nbsp;openstack network list</span>
</p>
<p class="MsoNormal" style="text-indent:24.0pt;">
    正常情况下无网络为空<span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:-18.0pt;">
    <span>3.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>创建网络<span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    <span>neutron net-create net1</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    创建好网络，显示网络的信息<span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:-18.0pt;">
    <span>4.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>在网络下创建子网<span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
	<span>openstack subnet create subnet1 --network net1
--subnet-range 192.168.2.0/24</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    需要指定子网<span>IP</span>的地址范围，为三级私有网络即可<span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    创建成功，显示子网的地址范围<span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:-18.0pt;">
    <span>5.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>查看网络<span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    <span>openstack network list</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    显示网络<span>net1</span>的<span>id</span>和<span>name</span>以及<span>subnets</span>的<span>id</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:-18.0pt;">
    <span>6.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>起一台虚拟机<span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    起虚拟机需要的参数有<span>netid,imageid,flavored</span>，所以进行查看<span>id</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    <span>openstack network list </span>查看<span>netid&nbsp; b6a4fe88-a461-4cbf-a97a-a70b467c087c</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    <span>glance image-list&nbsp; </span>查看<span>imageid&nbsp;&nbsp; cbdd40aa-f045-4cb6-b06a-183b0ba84341</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    <span>nova flavor-list&nbsp;&nbsp; </span>查看机器配置信息<span>flavorid</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    找好对应的<span>id</span>后，起虚拟机<span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
	<span>nova boot --flavor 1 --image
cbdd40aa-f045-4cb6-b06a-183b0ba84341 --nic
net-id=b6a4fe88-a461-4cbf-a97a-a70b467c087c vm1</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:-18.0pt;">
    <span>7.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>查看虚拟机是否起成功<span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    <span>nova list</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    当<span>Status</span>为<span>Active</span>即表示虚拟机起成功，<span>network</span>中显示该虚拟机的<span>IP</span>
</p>
<p class="MsoListParagraph" style="margin-left:54.0pt;text-indent:-36.0pt;">
    <span>x.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>在和该虚拟机通信，该虚拟机在隔离的<span>subnet</span>内，目前从外无法访问<span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    <span>sudo ip netns list</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    得到<span>netns</span>标识<span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
	<span>sudo ip netns exec
qdhcp-b6a4fe88-a461-4cbf-a97a-a70b467c087c ping 192.168.2.12</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    查看是否连接<span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    <span></span><span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    以及<span>ssh</span>连接<span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
	<span>sudo ip netns exec
qdhcp-b6a4fe88-a461-4cbf-a97a-a70b467c087c ssh <a href="mailto:cirros@192.168.2.12">cirros@192.168.2.12</a></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    <span></span><span></span>
</p>
<p class="MsoNormal">
    <b>镜像密码：<span></span></b>
</p>
<p class="MsoNormal">
    <span>http://www.chenshake.com/openstack-mirror-and-password/</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:-18.0pt;">
    <span>8.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>创建<span>external net</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
	<span>neutron net-create external_network --provider:network_type
vlan --provider:physical_network extern&nbsp;
--router:external</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:-18.0pt;">
    <span>9.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>创建<span>external </span>下的<span>subnet</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:24.0pt;">
	<span>neutron subnet-create --name public_subnet --enable_dhcp=False
--allocation-pool=start=192.168.127.10,end=192.168.127.20
--gateway=192.168.127.1 external_network 192.168.127.0/24</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:-18.0pt;">
    <span>10.&nbsp; </span>创建<span>router</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    <span>neutron router-create router1</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:-18.0pt;">
    <span>11.&nbsp; </span>使用外部网络设置其网关<span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    <span>neutron router-gateway-set router1 external_network</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:-18.0pt;">
    <span>12.&nbsp; </span>通过<span>router</span>链接<span>private net to the public network</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    <span>neutron router-interface-add router1 private_subnet</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:-18.0pt;">
    <span>13.&nbsp; </span>将网关和<span>br-ex</span>
</p>
<p class="MsoNormal" style="text-indent:24.0pt;">
    <span>ip address add 192.168.122.1 dev br-ex</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:-18.0pt;">
    <span>14.&nbsp; </span>新建<span>floatingip</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    <span>neutron floatingip-create external_network</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:-18.0pt;">
    <span>15.&nbsp; </span>查看虚拟机对应的<span>port</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    <span>nova list</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    <span>nova interface-list 8f79b5af-41b6-467f-b464-b328e1cbd26c</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:-18.0pt;">
    <span>16.&nbsp; </span><span>floatingip </span>和<span> vm port</span>的绑定<span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
    <span>neutron floatingip-list</span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:0cm;">
	<span>neutron floatingip-associate
93a63b29-af2c-404d-a1c1-cff706ca5aeb c13171db-2c70-466d-bd79-f976779addf1</span>（端口）<span></span>
</p>
<p style="margin-left:18.0pt;text-indent:-18.0pt;background:white;">
    17.&nbsp; 修改br-ex的IP，使其使用external
    net 网关地址
</p>
<p style="background:white;">
    注意：所有操作均使用root用户<br />
    修改IP：ifconfig
    &nbsp;eth0 &nbsp;10.10.22.145&nbsp; //直接将第一张网卡的IP修改成10.10.22.145<br />
    增加IP：ifconfig
    &nbsp;eth0 &nbsp;add &nbsp;10.10.33.145 &nbsp;//增加一个IP<br />
    再增加一个IP：ifconfig
    &nbsp;eth0:0 &nbsp;add&nbsp; 10.10.44.145
</p>
<p style="background:white;">
    上述增加完，立刻生效，但是机器重新启动后，就无效了。
</p>
<p class="MsoListParagraph" style="text-indent:0cm;">
    六． 常用命令<span></span>
</p>
<p class="MsoListParagraph" style="text-indent:0cm;">
    1. &nbsp;lbaas的命令 <span></span>
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:18.0pt;">
    neutron
    lbaas-loadbalancer-list
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:18.0pt;">
    neutron
    lbaas-loadbalancer-show 72435522-45ff-4d54-a50d-be4fcfbfbc65
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:18.0pt;">
    neutron
    lbaas-loadbalancer-update 72435522-45ff-4d54-a50d-be4fcfbfbc65 --admin_state_up
    False
</p>
<p class="MsoListParagraph" style="margin-left:18.0pt;text-indent:18.0pt;">
    <span class="apple-converted-space">&nbsp;</span>neutron
    lbaas-listener-create --loadbalancer test --protocol HTTP --protocol-port 80
    --name listener-test --connection-limit 100
</p>
<p class="MsoNormal">
    <span>2. </span>验证<span>lbaas</span>
</p>
<p class="MsoNormal" align="left" style="background:whitesmoke;">
    while true; do echo -e 'HTTP/1.0 200 OK\r\nContent-Length:
    8\r\n\r\n&lt;servername&gt;' | sudo nc -l -p 80&nbsp;; done
</p>
<p class="MsoNormal">
    <span>wget</span>命令总结<span></span>
</p>
<p class="MsoNormal">
    <span>http://blog.csdn.net/xifeijian/article/details/9399121</span>
</p>
<p class="MsoNormal">
	<span>while true; do sudo ip netns exec qdhcp-d836d00a-88f1-4388-a86f-284ab2ce9eac&nbsp; wget -O - http://192.168.2.5
--append-output=result.txt;done</span>
</p>
<p class="MsoNormal">
    <span>&nbsp;</span>
</p>
<p class="MsoNormal">
    <span>3. </span>查看日志<span></span>
</p>
<p class="MsoNormal">
	<span>&nbsp;
screen -x</span>
</p>
<h1>
    X．所遇问题<span></span>
</h1>
<p class="MsoNormal">
	<span>1. &nbsp;An
auth plugin is required to fetch a token</span>
</p>
<p class="MsoNormal">
    <span>neutron net-list </span>时出现此提示<span></span>
</p>
<p class="MsoNormal">
    <span>&nbsp;</span>
</p>
<p class="MsoNormal">
    <span>deal:</span>在<span> /devstack/</span>下<span>&nbsp; source openrc admin admin</span>
</p>
<p class="MsoNormal" style="text-indent:21.0pt;">
    <span></span><span></span>
</p>
<p class="MsoNormal" style="text-indent:21.0pt;">
    <span>&nbsp;</span>
</p>
<p class="MsoNormal" style="text-indent:21.0pt;">
    <span>2. br-ex</span>绑定<span>ip</span>出错<span></span>
</p>
<p class="MsoNormal" style="text-indent:21.0pt;">
    <span>&nbsp;&nbsp; https://my.oschina.net/u/1179767/blog/852538</span>
</p>
</body>
</html>